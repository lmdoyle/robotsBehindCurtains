<html>
  <head>
    <title>Robots Behind the Curtain</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.4.0/dist/aframe-extras.min.js"></script>
    <script src="./aframe-gui-master/dist/aframe-gui.js"></script>
    <script src="https://rawgit.com/caseyyee/aframe-ui-widgets/master/dist/aframe-ui-widgets.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@croquet/croquet@1.1.0"></script>
    <script src="https://croquet.io/sdk/croquet.min.js"></script>
    
    
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.164.1/build/three.module.js",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.164.1/examples/jsm/"
          
        }
      }
    </script>
    <script type="module">
      import { LoadingManager } from 'three';
      import { XacroLoader } from './xacroParser/XacroLoader.js';
      import URDFLoader from '/seniorProject/urdf/URDFLoader.js';
      

      



      document.addEventListener("DOMContentLoaded", function() {
    
        let modelInstance;

        /*Croquet.Session.join({
        apiKey: '1BnN4MOyI2yEFd0lIzuGNaJjoPGB9e2djtPutg8lx',
        appId: 'com.gmail.leodoyle05.myapp',
        sessionName: 'robotsBehindCurtains',
        password: '1234',
        model: TestModel,
        debug: ["session", "subscribe", "sends", "messages", "classes"],
        view: TestView,
        options: {spawnPoint: this.data.spawnPoint},
    /* (more join options)... 
})*/
console.log("fully loaded");
//const session = document.querySelector('a-scene').systems;
//console.log(session);
});


      // ...init three.js scene...

      const scene = document.querySelector('a-scene').object3D;

      let robot = "gen3"; 
      let path = "";

      //update robot
      function updateRobotState(newRobot) {
      robot = newRobot;
      console.log("Robot is now:", robot);
      }
      

      //if loop
      if(robot=="husky"){
        path = "./husky/iral_gen3_robot_description.urdf";
      }else if(robot=="gen3"){
        path = "./gen3/iral_husky_robot_description.urdf";
      }else{
        path = "T12/urdf/T12.URDF"
      }

      let husky;
      let gen3;
      

      const manager = new LoadingManager();
    const loader = new URDFLoader( manager );
      /*loader.packages = {
          packageName : './package/seniorProject/husky/husky_description'            // The equivalent of a (list of) ROS package(s):// directory
      };*/
      loader.load(
        //T12: T12/urdf/T12.URDF 
        //husky: ./husky/iral_gen3_robot_description.urdf
        //gen 3 arm: ./gen3/iral_husky_robot_description.urdf
        './husky/iral_gen3_robot_description.urdf',                     
        robot => {
          // The robot is loaded!
          scene.add( robot );
          robot.rotateX(-1.57);
          robot.scale.set(5,5,5);
          husky = robot;
          husky.visible = false;
        }
      );
      

      loader.load(
        //T12: T12/urdf/T12.URDF 
        //husky: ./husky/iral_gen3_robot_description.urdf
        //gen 3 arm: ./gen3/iral_husky_robot_description.urdf
        './gen3/iral_husky_robot_description.urdf',                     
        robot => {
          // The robot is loaded!
          scene.add( robot );
          robot.rotateX(-1.57);
          robot.scale.set(5, 5, 5);
          robot.position.set(0, 0, -8)
          gen3 = robot;
          //gen3.visible = false;
        }
      );

      
      AFRAME.registerComponent('custom-look-at', {
        schema: {
          target: { type: 'selector' }
        },
        tick: function () {
          const targetEl = this.data.target;
          if (!targetEl) { return; }

          const targetPosition = new THREE.Vector3();
          targetEl.object3D.getWorldPosition(targetPosition);

          this.el.object3D.lookAt(targetPosition);
        }
      });
 


        

    AFRAME.registerComponent('hover-color', {
        schema: {
          color: {type: 'color', default: 'red'}
        },
        init: function () {
          var originalColor = this.el.getAttribute('material').color;
          var hoverColor = this.data.color;

          this.el.addEventListener('mouseenter', () => {
            this.el.setAttribute('material', 'color', hoverColor);
          });

          this.el.addEventListener('mouseleave', () => {
            this.el.setAttribute('material', 'color', originalColor);
          });  
        }
      });

      //husky values
      let huskyFrontRightWheelValue = 0;
      let huskyFrontLeftWheelValue = 0;
      let huskyBackRightWheelValue = 0;
      let huskyBackLeftWheelValue = 0;
      let j2n6s300Joint1Value = 0;
      let j2n6s300Joint2Value = 0;
      let j2n6s300Joint3Value = 0;
      let j2n6s300Joint4Value = 0;
      let j2n6s300Joint5Value = 0;
      let j2n6s300Joint6Value = 0;
      let j2n6s300FingerJoint1Value = 0;
      let j2n6s300FingerJoint2Value = 0;
      let j2n6s300FingerJoint3Value = 0;
      let j2n6s300FingerTipJoint1Value = 0;
      let j2n6s300FingerTipJoint2Value = 0;
      let j2n6s300FingerTipJoint3Value = 0;

      //gen3 values
      let joint1Value = 0;
      let joint2Value = 0;
      let joint3Value = 0;
      let joint4Value = 0;
      let joint5Value = 0;
      let joint6Value = 0;
      let fingerJointValue = 0;
      let jointLIKValue = 0;
      let jointLIFValue = 0;
      let jointRIKValue = 0;
      let jointRIFValue = 0;
/*
The MIT License (MIT)
Copyright (c) 2019-2023 Nikolai Suslov | Krestianstvo.org and contributors
*/





class RootModel extends Croquet.Model {

    init(options) {
        super.init(options);

    this.rotation = { x: 0, y: 0, z: 0 };
    this.rotatingCube = document.getElementById("rotatingCube");
    this.camera = document.querySelector("#camera");

    //rock subscribe
    this.subscribe("keydown", "1", this.roboRock);

    //paper subscribe
    this.subscribe("keydown", "2", this.roboPaper);

    //scissors subscribe
    this.subscribe("keydown", "3", this.roboScissors);

    //reset subscirbe
    this.subscribe('keydown', "4", this.roboReset);

    this.subscribe("vr-button", "rock", this.vrRock);
    this.subscribe("vr-button", "paper", this.vrPaper);
    this.subscribe("vr-button", "scissors", this.vrScissors);
    this.subscribe("vr-button", "reset", this.vrReset);

    this.subscribe('vr', 'enter', this.vrEnter);
    this.subscribe('vr', 'exit', this.vrExit);

    
      

    }

    vrEnter(){

        
      //this.rotatingCube = document.getElementById("rotatingCube");
      this.camera = document.querySelector('#camera');
      var cameraObject = camera.object3D;
      this.rotation = {x: THREE.MathUtils.radToDeg(this.camera.object3D.rotation.x),
                       y: THREE.MathUtils.radToDeg(this.camera.object3D.rotation.y),
                       z: THREE.MathUtils.radToDeg(this.camera.object3D.rotation.z)};

      //camera.setAttribute('look-controls-enabled', 'true');
      //this.rotation = camera.getAttribute('rotation');

      

      
          // Apply the camera's rotation to the cube
      this.rotatingCube.setAttribute('rotation', this.rotation);
      this.future(500).vrEnter();
      console.error("VR ENTER");
      console.error(this.rotation);
     

      //onsole.error(rotation);
      //this.future(5).vrEnter();
    }

    vrExit(){
      this.cancelFuture(this.vrEnter);
      console.error("VR EXIT");
    }

    

    vrRock(){
      console.warn("rock");
      var playerObject = document.querySelector('#playerObject');
      playerObject.setAttribute('gltf-model', 'Assets/rock_2.gltf');
    }

    vrPaper(){
      console.warn("paper");
      var playerObject = document.querySelector('#playerObject');
      playerObject.setAttribute('gltf-model', 'Assets/paper.gltf');
    }

    vrScissors(){
      console.warn("scissors");
      var playerObject = document.querySelector('#playerObject');
      playerObject.setAttribute('gltf-model', 'Assets/scissors.gltf');
    }

    vrReset(){
      console.warn("reset");
      var playerObject = document.querySelector('#playerObject');
      playerObject.setAttribute('gltf-model', 'Assets/hand.gltf');
    }

    roboRock(){
      gen3.setJointValue("joint_2", 1.57);
      gen3.setJointValue("joint_3", 1.57);
      gen3.setJointValue("joint_5", 0);
      gen3.setJointValue("left_inner_finger_joint", 0);
      gen3.setJointValue("right_inner_finger_joint", 0);

      var playerObject = document.querySelector('#pcObject');
      playerObject.setAttribute('gltf-model', 'Assets/rock_2.gltf');
      
      
      console.warn("rock");
    }

    roboPaper(){
      gen3.setJointValue("joint_2", -1.57);
      gen3.setJointValue("joint_3", -1.57);
      gen3.setJointValue("joint_5", 0);
      gen3.setJointValue("left_inner_finger_joint", 1);
      gen3.setJointValue("right_inner_finger_joint", 0);

      var playerObject = document.querySelector('#pcObject');
      playerObject.setAttribute('gltf-model', 'Assets/paper.gltf');
      
      
      console.warn("paper");
    }
    roboScissors(){
      gen3.setJointValue("joint_2", -1);
      gen3.setJointValue("joint_3", -2);
      gen3.setJointValue("joint_5", 1);
      gen3.setJointValue("left_inner_finger_joint", 0);
      gen3.setJointValue("right_inner_finger_joint", 1);

      var playerObject = document.querySelector('#pcObject');
      playerObject.setAttribute('gltf-model', 'Assets/scissors.gltf');
      
      
      console.warn("scissors");
    }

    roboReset(){
      gen3.setJointValue("joint_2", 0);
      gen3.setJointValue("joint_3", 0);
      gen3.setJointValue("joint_5", 0);
      gen3.setJointValue("left_inner_finger_joint", 0);
      gen3.setJointValue("right_inner_finger_joint", 0);

      var playerObject = document.querySelector('#pcObject');
      playerObject.setAttribute('gltf-model', 'Assets/hand.gltf');

      console.warn("reset");
    }
   
     
}

class RootView extends Croquet.View {

    constructor(model) {
        super(model);
            
            this.i = 0;
        
           

            

      // Add event listener for keydown events
      window.addEventListener('keydown', (event)=>{
                if(event.key === "1"){
                 this.publish("keydown", "1");
                 console.warn("1 key published");
                }else if(event.key === "2"){
                 this.publish("keydown", "2");
                 console.warn("2 key published");
                }else if(event.key === "3"){
                 this.publish("keydown", "3");
                 console.warn("3 key published");
                }else if(event.key === "4"){
                 this.publish("keydown", "4");
                 console.warn("4 key published");
                }
              });

        var controller1 = document.querySelector('#leftHand');
        var controller2 = document.querySelector('#rightHand');

        controller2.addEventListener('abuttondown', () => {
          this.publish("vr-button", "rock");
        })

        controller2.addEventListener('bbuttondown', () => {
          this.publish("vr-button", "paper");
        })

        controller1.addEventListener('xbuttondown', () => {
          this.publish("vr-button", "scissors");
        })

        controller1.addEventListener('ybuttondown', () => {
          this.publish("vr-button", "reset");
        })

        var cameraRig = document.querySelector('#cameraRig');

        // Create the left hand controller entity
        var leftHand = document.createElement('a-entity');
        leftHand.setAttribute('id', 'leftHand');
        leftHand.setAttribute('oculus-touch-controls', 'hand: left');
        leftHand.setAttribute('hand-tracking-controls', 'hand: left');
        leftHand.setAttribute('laser-controls', 'hand: left');
        leftHand.setAttribute('raycaster', 'objects: .clickable; far: 30');
        leftHand.setAttribute('line', 'color: red; opacity: 0.75');
        leftHand.setAttribute('visible', 'true');

        // Create the right hand controller entity
        var rightHand = document.createElement('a-entity');
        rightHand.setAttribute('id', 'rightHand');
        rightHand.setAttribute('oculus-touch-controls', 'hand: right');
        rightHand.setAttribute('hand-tracking-controls', 'hand: right');
        rightHand.setAttribute('laser-controls', 'hand: right');
        rightHand.setAttribute('raycaster', 'objects: .clickable; far: 30');
        rightHand.setAttribute('line', 'color: red; opacity: 0.75');
        rightHand.setAttribute('visible', 'true');

        // Append the controllers to the camera rig
        cameraRig.appendChild(leftHand);
        cameraRig.appendChild(rightHand);

        var scene1 = document.querySelector('a-scene');

        scene1.addEventListener("enter-vr", ()=>{
          this.publish('vr', 'enter');
        })

        scene1.addEventListener('exit-vr', ()=> {
          this.publish('vr', 'exit');
        })

        

      

    }

   

   

    

}

RootModel.register("RootModel");


AFRAME.registerComponent('croquet', {

    schema: {
        sessionName: { default: 'demo' },
        password: { default: 'demo' },
        apiKey: {default: 'myApiKey'},
        spawnPoint: {type: 'vec3'},
    },

    init: function () {
       
        Croquet.Session.join({
            apiKey: '1BnN4MOyI2yEFd0lIzuGNaJjoPGB9e2djtPutg8lx',
            appId: 'com.gmail.leodoyle05.myapp',
            sessionName: 'robotsBehindCurtains',
            password: '1234',
            model: RootModel,
            debug: ["session", "subscribe", "sends", "messages", "classes"],
            view: RootView,
            options: {spawnPoint: this.data.spawnPoint},
        }
        )
    }
})




 






document.addEventListener('keydown', function(event) {
        // Check if the 'b' key is pressed
        if (event.key === 'b' || event.key === 'B') {
          // Get the player object
          var playerObject = document.querySelector('#playerObject');
          
          // Change the GLTF model
          playerObject.setAttribute('gltf-model', 'Assets/rock_2.gltf');
        } else  if (event.key === 'n' || event.key === 'N') {
          // Get the player object
          var playerObject = document.querySelector('#playerObject');
          
          // Change the GLTF model
          playerObject.setAttribute('gltf-model', 'Assets/paper.gltf');
        }else  if (event.key === 'm' || event.key === 'M') {
          // Get the player object
          var playerObject = document.querySelector('#playerObject');
          
          // Change the GLTF model
          playerObject.setAttribute('gltf-model', 'Assets/scissors.gltf');
        }else  if (event.key === 'c' || event.key === 'C') {
          // Get the player object
          var playerObject = document.querySelector('#playerObject');
          
          // Change the GLTF model
          playerObject.setAttribute('gltf-model', 'Assets/hand.gltf');
        }
      });

      document.addEventListener('keydown', (event) => {
        if(event.key === 'g' || event.key === 'G'){
          var cameraRig = document.querySelector("#cameraRig").object3D;
          var camera = document.querySelector("#camera").object3D;
          console.warn(cameraRig.position);
          console.warn(cameraRig.rotation);
          console.warn(camera.position);
          console.warn(camera.rotation);
          console.warn('test');
        }else if(event.key === 'v' || event.key === 'V'){
          //default positioning
          var cameraRig = document.querySelector("#cameraRig");
          var camera = document.querySelector('#camera');

          cameraRig.setAttribute('position', {x: 0.12, y: 1.6, z: -4.87});
          cameraRig.setAttribute('rotation', {x: -0.004, y: -0.036, z: 0});

          camera.setAttribute('position', {x: -0.543, y: 1.6, z: 9.96});
          camera.setAttribute('rotation', {x: 0, y: 0, z: 0});
        }else if(event.key === 'p' || event.key === "P"){
          var cameraRig = document.querySelector("#cameraRig");
          var camera = document.querySelector('#camera');

          cameraRig.setAttribute('position', {x: -3.68, y: 1.6, z: -6.60});
          cameraRig.setAttribute('rotation', {x: -0.00006, y: 180, z: 0});

          camera.setAttribute('position', {x: .84, y: 1.6, z: 7.12});
          camera.setAttribute('rotation', {x: 0, y: 380, z: 0});
        }
      })

      var scene1 = document.querySelector('a-scene');

      scene1.addEventListener('enter-vr', function () {
        // Hide cursor in VR
        var cameraRig = document.querySelector("#cameraRig");
          var camera = document.querySelector('#camera');

          cameraRig.setAttribute('position', '0.12 1.6 4.87');
          cameraRig.setAttribute('rotation', '-0.004 -0.036 0');

          camera.setAttribute('position', '-0.543 1.6 9.96');
          camera.setAttribute('rotation', '0 0 0');
      });

      scene1.addEventListener('exit-vr', ()=>{
        var cameraRig = document.querySelector("#cameraRig");
        var camera = document.querySelector('#camera');

          cameraRig.setAttribute('position', {x: -3.68, y: 1.6, z: -6.60});
          cameraRig.setAttribute('rotation', {x: -0.00006, y: 180, z: 0});

          camera.setAttribute('position', {x: .84, y: 1.6, z: 7.12});
          camera.setAttribute('rotation', {x: 0, y: 380, z: 0});
      })

     

      


               
  


     
    </script>
    
  </head>
  <body>
    <a-scene croquet>
      <a-assets>
        <a-asset-item id="cityModel" src="Assets/rock_2.gltf"></a-asset-item>
        <a-asset-item id="rock" src="Assets/rock_2.gltf"></a-asset-item>
        <a-asset-tiem id="paper" src="Assets/paper.gltf"></a-asset-tiem>
        <a-asset-item id="scissors" src="Assets/scissors.gltf"></a-asset-item>
        <a-asset-item id="hand" src="Assets/hand.gltf"></a-asset-item>
      </a-assets>

      <template id="avatarTemplate">
        <a-box></a-box>
    </template>

    <a-entity id="playerObject" pos = "0 3 0" gltf-model="#hand"></a-entity>
    <a-entity id="pcObject" position = "-1 0.5 -7" gltf-model="#hand"></a-entity>

    <a-box id="rotatingCube" position=".12 3 5.96" scale="1 2 1"></a-box>

    <a-plane id="ocolusControls" position="4.5 3 0" custom-look-at="target: #rotatingCube" scale=" 3 3 3" src="./Assets/oculusControls3.png">
    <a-plane id="robotControls" position="-6.5 0 1" custom-look-at="target: #rotatingCube" scale=" 3 3 3" src="./Assets/robotPositions.png"></a-plane>
    <a-plane id="keyboardControls" position="-4 0 1" custom-look-at="target: #playerBox" scale=" 2 2 2" src="./Assets/keyboardControls.png"></a-plane>
      
    </a-plane>
     
    <a-entity id="cameraRig" position="-3.68 1.6 -6.60" rotation=" 0 180 0">
      <a-camera id ="camera" position =".84 1.6 7.12"rotation="0 380 0"  wasd-controls-enabled="false" look-controls-enabled="false">
       
      </a-camera>
      

      <a-entity id= "leftHand" oculus-touch-controls="hand: left" hand-tracking-controls="hand: left" laser-controls="hand: left" raycaster="objects: .clickable; far: 30" line="color: red; opacity: 0.75" visible="true"></a-entity>

      <a-entity id="rightHand" oculus-touch-controls="hand: right" hand-tracking-controls="hand: right" laser-controls="hand: right" raycaster="objects: .clickable; far: 30" line="color: red; opacity: 0.75" visible="true"></a-entity>
  </a-entity>

  <a-box id="playerBox" position="-4 0 -12" rotation=" 0 180 0" material="opacity: 0.0; transparent: true"></a-box>

      

      <a-plane id = "robotPlatform" position="0 0 -8" rotation="-90 0 0" width="3" height="3" color="#AD9F93"></a-plane>
      <a-plane position=".12 1 4.96" rotation="-90 0 0" width="3" height="3" color="#AD9F93"></a-plane>

      <!--sky color=#A7896C-->
      <a-sky color="#A7896C"></a-sky>
    </a-scene>
  </body>
</html>
